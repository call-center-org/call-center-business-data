name: Deploy to Aliyun OSS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "18"
        cache: "npm"
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build project
      run: npm run build
      
    - name: Fix paths for Aliyun OSS
      run: node fix-paths.js
      
    - name: Copy WeChat verification file
      run: cp 2b0f35d6f92d93aaa4a22103f1bf4553.txt dist/
      
    - name: Configure Aliyun CLI
      run: |
        wget https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz
        tar -xzf aliyun-cli-linux-latest-amd64.tgz
        sudo mv aliyun /usr/local/bin/
        aliyun configure set \
          --profile default \
          --mode AK \
          --region ${{ secrets.ALIYUN_OSS_REGION }} \
          --access-key-id ${{ secrets.ALIYUN_ACCESS_KEY_ID }} \
          --access-key-secret ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
          
    - name: Deploy to Aliyun OSS
      run: |
        # 安装 ossutil
        wget https://gosspublic.alicdn.com/ossutil/1.7.20/ossutil64
        chmod +x ossutil64
        sudo mv ossutil64 /usr/local/bin/ossutil
        
        # 配置 ossutil
        ossutil config -e ${{ secrets.ALIYUN_OSS_REGION }}.aliyuncs.com \
          -i ${{ secrets.ALIYUN_ACCESS_KEY_ID }} \
          -k ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
          
        # 上传文件到 OSS
        ossutil cp -r dist/ oss://${{ secrets.ALIYUN_OSS_BUCKET }}/ --force
        
    - name: Deploy status
      run: |
        echo "✅ 部署完成！"
        echo "🌐 访问地址：https://${{ secrets.ALIYUN_OSS_BUCKET }}.${{ secrets.ALIYUN_OSS_REGION }}.aliyuncs.com"
        echo "📱 微信认证：https://${{ secrets.ALIYUN_OSS_BUCKET }}.${{ secrets.ALIYUN_OSS_REGION }}.aliyuncs.com/2b0f35d6f92d93aaa4a22103f1bf4553.txt"
