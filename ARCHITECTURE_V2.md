# æ¶æ„æ–‡æ¡£ v2.0

> å¤–å‘¼æ•°æ®ç³»ç»Ÿ - å‰åç«¯åˆ†ç¦»æ¶æ„

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·æµè§ˆå™¨                          â”‚
â”‚                   (http://localhost:3001)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    HTTP/HTTPS + JWT Token
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å‰ç«¯æœåŠ¡ (React + Vite)                â”‚
â”‚  - ç”¨æˆ·ç•Œé¢å±•ç¤º                                          â”‚
â”‚  - JWT Token ç®¡ç†                                        â”‚
â”‚  - è°ƒç”¨åç«¯ API                                          â”‚
â”‚  ç«¯å£: 3001                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    RESTful API + JWT Auth
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åç«¯æœåŠ¡ (Flask)                       â”‚
â”‚  - JWT è®¤è¯                                              â”‚
â”‚  - ä¸šåŠ¡é€»è¾‘å¤„ç†                                          â”‚
â”‚  - æ•°æ®åŒæ­¥è°ƒåº¦                                          â”‚
â”‚  - è°ƒç”¨å† å®¢ API                                          â”‚
â”‚  ç«¯å£: 5001                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                                â†“
   HTTPS (å† å®¢å¯†é’¥)                  SQL Queries
         â†“                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å† å®¢ API        â”‚          â”‚   æ•°æ®åº“ (SQLite/PG)   â”‚
â”‚ open-api.gooki   â”‚          â”‚  - call_records        â”‚
â”‚  - é€šè¯è®°å½•       â”‚          â”‚  - daily_stats         â”‚
â”‚  - ä»»åŠ¡æ•°æ®       â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ æŠ€æœ¯æ ˆ

### å‰ç«¯

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| React | 18.x | UI æ¡†æ¶ |
| Vite | 5.x | æ„å»ºå·¥å…· |
| TailwindCSS | 3.x | æ ·å¼æ¡†æ¶ |
| Axios | 1.x | HTTP å®¢æˆ·ç«¯ |
| Lucide React | - | å›¾æ ‡åº“ |
| React Hot Toast | - | é€šçŸ¥æç¤º |

### åç«¯

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Flask | 2.3.x | Web æ¡†æ¶ |
| Flask-CORS | 4.0.x | è·¨åŸŸæ”¯æŒ |
| Flask-SQLAlchemy | 3.0.x | ORM |
| Flask-Migrate | 4.0.x | æ•°æ®åº“è¿ç§» |
| PyJWT | 2.8.x | JWT è®¤è¯ |
| Requests | 2.31.x | HTTP å®¢æˆ·ç«¯ |

### æ•°æ®åº“

| ç¯å¢ƒ | æ•°æ®åº“ | è¯´æ˜ |
|------|--------|------|
| å¼€å‘ | SQLite | æ— éœ€é…ç½®ï¼Œå¼€ç®±å³ç”¨ |
| ç”Ÿäº§ | PostgreSQL | æ¨èï¼Œæ€§èƒ½æ›´å¥½ |

---

## ğŸ” è®¤è¯æ¶æ„

### JWT Token æµç¨‹

```
1. ç”¨æˆ·ç™»å½• ERP ç³»ç»Ÿï¼ˆæœªæ¥ï¼‰
        â†“
2. ERP ç”Ÿæˆ JWT Token
        â†“
3. Token å­˜å‚¨åœ¨ localStorage
        â†“
4. å‰ç«¯è¯·æ±‚æ—¶æºå¸¦ Token
        â†“
5. åç«¯éªŒè¯ Token
        â†“
6. Token æœ‰æ•ˆ â†’ è¿”å›æ•°æ®
   Token æ— æ•ˆ â†’ è¿”å› 401
```

### JWT Token ç»“æ„

```json
{
  "user_id": 1,
  "username": "test_user",
  "role": "admin",
  "exp": 1729123456,
  "iat": 1729037056
}
```

### å¼€å‘ç¯å¢ƒ Token ç”Ÿæˆ

```bash
python backend/scripts/generate_test_token.py
```

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### è¡¨ç»“æ„

#### call_recordsï¼ˆé€šè¯è®°å½•ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|------|------|------|------|
| id | Integer | ä¸»é”® | PK |
| call_id | String(100) | é€šè¯IDï¼ˆå”¯ä¸€ï¼‰ | âœ… |
| task_id | String(100) | ä»»åŠ¡ID | âœ… |
| task_name | String(200) | ä»»åŠ¡åç§° | - |
| agent_id | String(100) | åå¸­ID | âœ… |
| agent_name | String(100) | åå¸­åç§° | - |
| phone | String(20) | å®¢æˆ·ç”µè¯ | - |
| start_time | DateTime | å¼€å§‹æ—¶é—´ | âœ… |
| end_time | DateTime | ç»“æŸæ—¶é—´ | - |
| duration | Integer | é€šè¯æ—¶é•¿ï¼ˆç§’ï¼‰ | - |
| hangup_reason | String(50) | æŒ‚æœºåŸå›  | - |
| is_success | Boolean | æ˜¯å¦æˆåŠŸ | âœ… |
| created_at | DateTime | åˆ›å»ºæ—¶é—´ | - |
| synced_at | DateTime | åŒæ­¥æ—¶é—´ | - |

#### daily_statsï¼ˆæ¯æ—¥ç»Ÿè®¡ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|------|------|------|------|
| id | Integer | ä¸»é”® | PK |
| stat_date | Date | ç»Ÿè®¡æ—¥æœŸï¼ˆå”¯ä¸€ï¼‰ | âœ… |
| total_calls | Integer | æ€»å‘¼å‡º | - |
| success_calls | Integer | æˆåŠŸå‘¼å‡º | - |
| failed_calls | Integer | å¤±è´¥å‘¼å‡º | - |
| success_rate | Float | æˆåŠŸç‡ | - |
| total_duration | Integer | æ€»æ—¶é•¿ | - |
| avg_duration | Float | å¹³å‡æ—¶é•¿ | - |
| created_at | DateTime | åˆ›å»ºæ—¶é—´ | - |
| updated_at | DateTime | æ›´æ–°æ—¶é—´ | - |

---

## ğŸ”„ æ•°æ®æµç¨‹

### 1. æ•°æ®åŒæ­¥æµç¨‹

```
å®šæ—¶ä»»åŠ¡/æ‰‹åŠ¨è§¦å‘
        â†“
åç«¯è°ƒç”¨å† å®¢ API
        â†“
è·å–é€šè¯è®°å½•
        â†“
æ•°æ®æ¸…æ´—å’Œå¤„ç†
        â†“
åˆ¤æ–­æˆåŠŸ/å¤±è´¥
        â†“
ä¿å­˜åˆ° call_records
        â†“
è®¡ç®—æ¯æ—¥ç»Ÿè®¡
        â†“
æ›´æ–° daily_stats
```

### 2. æ•°æ®æŸ¥è¯¢æµç¨‹

```
å‰ç«¯å‘èµ·è¯·æ±‚
        â†“
åç«¯éªŒè¯ JWT Token
        â†“
æŸ¥è¯¢ daily_stats è¡¨
        â†“
è®¡ç®—æ±‡æ€»æ•°æ®
        â†“
è¿”å› JSON æ•°æ®
        â†“
å‰ç«¯å±•ç¤º
```

### 3. æˆåŠŸåˆ¤æ–­æ ‡å‡†

```python
is_success = (
    hangup_reason == 'NORMAL_CLEARING' and
    duration > 0
)
```

---

## ğŸ› ï¸ API è®¾è®¡

### RESTful API è§„èŒƒ

| æ–¹æ³• | è·¯å¾„ | è®¤è¯ | è¯´æ˜ |
|------|------|------|------|
| GET | `/api/health` | âŒ | å¥åº·æ£€æŸ¥ |
| GET | `/api/calls/summary` | âœ… | è·å–æ¦‚è§ˆ |
| GET | `/api/calls/daily` | âœ… | æ¯æ—¥æ˜ç»† |
| POST | `/api/calls/sync` | âœ… | åŒæ­¥æ•°æ® |
| GET | `/api/stats/overview` | âœ… | ç»Ÿè®¡æ¦‚è§ˆ |
| GET | `/api/stats/trend` | âœ… | è¶‹åŠ¿æ•°æ® |

### ç»Ÿä¸€å“åº”æ ¼å¼

**æˆåŠŸ**ï¼š
```json
{
  "success": true,
  "data": { ... }
}
```

**å¤±è´¥**ï¼š
```json
{
  "success": false,
  "error": "é”™è¯¯ä¿¡æ¯"
}
```

---

## ğŸ”§ é…ç½®ç®¡ç†

### ç¯å¢ƒå˜é‡

#### åç«¯ (.env)

```env
# Flask ç¯å¢ƒ
FLASK_ENV=development|production
PORT=5001

# å¯†é’¥
SECRET_KEY=<éšæœºå­—ç¬¦ä¸²>
JWT_SECRET_KEY=call-center-secret-key-2024-change-in-production

# æ•°æ®åº“
DATABASE_URL=sqlite:///business_data.db  # æˆ– PostgreSQL URL

# å† å®¢ API
GUANKE_BASE_URL=https://open-api.gooki.com
GUANKE_API_SECRET=<ä½ çš„å¯†é’¥>
```

#### å‰ç«¯ (.env.development)

```env
VITE_BACKEND_URL=http://localhost:5001
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ç´¢å¼•

- `call_records.call_id` - å”¯ä¸€ç´¢å¼•
- `call_records.task_id` - æ™®é€šç´¢å¼•
- `call_records.agent_id` - æ™®é€šç´¢å¼•
- `call_records.start_time` - æ—¶é—´æŸ¥è¯¢ä¼˜åŒ–
- `call_records.is_success` - ç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–
- `daily_stats.stat_date` - å”¯ä¸€ç´¢å¼•

### 2. æŸ¥è¯¢ä¼˜åŒ–

- ä½¿ç”¨ `daily_stats` é¢„è®¡ç®—è¡¨åŠ é€ŸæŸ¥è¯¢
- é¿å…å®æ—¶è®¡ç®—å¤§é‡æ•°æ®
- åˆ†é¡µæŸ¥è¯¢ï¼ˆæœªæ¥ï¼‰

### 3. ç¼“å­˜ç­–ç•¥ï¼ˆæœªæ¥ï¼‰

- Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®
- å®šæ—¶åˆ·æ–°ç¼“å­˜
- ç¼“å­˜å¤±æ•ˆç­–ç•¥

---

## ğŸš€ éƒ¨ç½²æ¶æ„

### å¼€å‘ç¯å¢ƒ

```
å‰ç«¯: http://localhost:3001
åç«¯: http://localhost:5001
æ•°æ®åº“: SQLite (æœ¬åœ°æ–‡ä»¶)
```

### ç”Ÿäº§ç¯å¢ƒï¼ˆZeaburï¼‰

```
å‰ç«¯: https://frontend-xxx.zeabur.app
åç«¯: https://backend-xxx.zeabur.app
æ•°æ®åº“: PostgreSQL (Zeabur æ‰˜ç®¡)
```

---

## ğŸ“ ä»£ç ç»“æ„

### åç«¯

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py         # Flask åº”ç”¨å·¥å‚
â”‚   â”œâ”€â”€ config.py           # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â””â”€â”€ auth.py         # JWT è®¤è¯è£…é¥°å™¨
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ call_record.py  # é€šè¯è®°å½•æ¨¡å‹
â”‚   â”‚   â””â”€â”€ daily_stat.py   # ç»Ÿè®¡æ¨¡å‹
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ health.py       # å¥åº·æ£€æŸ¥
â”‚   â”‚   â”œâ”€â”€ calls.py        # å‘¼å‡ºæ•°æ®æ¥å£
â”‚   â”‚   â””â”€â”€ stats.py        # ç»Ÿè®¡æ¥å£
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ guanke_api.py   # å† å®¢ API å®¢æˆ·ç«¯
â”‚       â””â”€â”€ data_processor.py  # æ•°æ®å¤„ç†æœåŠ¡
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ init_db.py          # æ•°æ®åº“åˆå§‹åŒ–
â”‚   â”œâ”€â”€ generate_test_token.py  # ç”Ÿæˆæµ‹è¯• Token
â”‚   â””â”€â”€ sync_initial_data.py    # é¦–æ¬¡æ•°æ®åŒæ­¥
â”œâ”€â”€ requirements.txt
â””â”€â”€ run.py
```

### å‰ç«¯

```
src/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ CallStatistics.jsx  # ç»Ÿè®¡ç»„ä»¶ï¼ˆæ—§ï¼‰
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ apiClient.js        # æ—§çš„ API å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ backendApiClient.js # æ–°çš„åç«¯å®¢æˆ·ç«¯
â”‚   â””â”€â”€ backendApi.js       # æ–°çš„ API æ¥å£
â””â”€â”€ App.jsx
```

---

## ğŸ”® æœªæ¥è§„åˆ’

### Phase 1ï¼ˆå·²å®Œæˆï¼‰
- âœ… åç«¯åŸºç¡€æ¶æ„
- âœ… JWT è®¤è¯
- âœ… æ•°æ®åº“è®¾è®¡
- âœ… æ ¸å¿ƒ API

### Phase 2ï¼ˆå¾…å¼€å‘ï¼‰
- [ ] å‰ç«¯å®Œå…¨è¿ç§»åˆ°æ–° API
- [ ] å®šæ—¶ä»»åŠ¡ï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰
- [ ] æ›´å¤šç»Ÿè®¡ç»´åº¦ï¼ˆåå¸­ã€ä»»åŠ¡ï¼‰

### Phase 3ï¼ˆæœªæ¥ï¼‰
- [ ] Redis ç¼“å­˜
- [ ] å®æ—¶æ•°æ®æ¨é€
- [ ] æ•°æ®å¯¼å‡ºåŠŸèƒ½
- [ ] é«˜çº§æ•°æ®åˆ†æ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**æœ€åæ›´æ–°**: 2025-10-19

































